<html>
	<head>
		<title>Dirigenten</title>
		<script src="node_modules/leapjs/leap-0.6.4.min.js"></script>
		<script src="node_modules/jquery/dist/jquery.min.js"></script>
		<script src="node_modules/socket.io-client/dist/socket.io.js"></script>
	</head>
	<body>
		
		<h1>Dirigenten Interface</h1>

		<!-- HTML Audio Output -->
		<audio id="audioHTMLPlayer1" width="320" height="176" controls>
			<source src="music/waltz2/185.mp3" type="audio/mp3">
			Your browser does not support HTML5 audio.
		</audio>
		<br>
		<audio id="audioHTMLPlayer2" width="320" height="176" controls>
			<source src="music/waltz2/185.mp3" type="audio/mp3">
			Your browser does not support HTML5 audio.
		</audio>

		<hr>

		<!-- Debug -->

		<h2>Debug</h2>
		<div id="debug"></div>
		<div id="debugHands"></div>


		<!-- Clientside Javascript -->
		<script type="text/javascript">

			console.log("Clientside initialized. LeapJS v" + Leap.version.full);


			// Socket Controller
			var socket = io('http://localhost:8080');


			// Audio Controller
			var audioPlayer1 = $('#audioHTMLPlayer1')[0];
			var audioPlayer2 = $('#audioHTMLPlayer2')[0];

			var activePlayer = audioPlayer1;
			var inactivePlayer = audioPlayer2;
			var changeOffset = 0.115;

			function changeActivePlayer(){
				var temp = activePlayer;

				activePlayer = inactivePlayer;
				inactivePlayer = temp;
			}

			function changeSong(url){

				var oldPercent = 0.0;
				
		        if(url == "music/waltz2/210.mp3"){

		        	oldPercent = (activePlayer.currentTime*100)/103;
		        	inactivePlayer.setAttribute('src', url);
		        	inactivePlayer.load();
		        	inactivePlayer.currentTime = (92*oldPercent)/100 + changeOffset;

		        } else {

		        	oldPercent = (activePlayer.currentTime*100)/92;
		        	inactivePlayer.setAttribute('src', url);
		        	inactivePlayer.load();
		        	inactivePlayer.currentTime = (103*oldPercent)/100 + changeOffset;

		        }

		        changeActivePlayer();

		        // Cross fade the players and pause the inactive one.
		        $(inactivePlayer).animate({volume: 0.0}, 10, function(){
		        	inactivePlayer.pause();
		        });
		        
		        activePlayer.play();
		        $(activePlayer).animate({volume: 1.0}, 10);

			}
			

			// Leap Controller input
			var leap = new Leap.Controller({enableGestures: false});
			leap.loop(function(frame){

				$('#debug').text(frame);
				$('#debugHands').text(frame.hands);

				if(frame.hands[0]){
					var vol = (frame.hands[0].palmPosition[1]*100)/400;
					vol = vol/100;

					if(vol > 1.0){ vol = 1.0; }
					if(vol < 0.1){ vol = 0.0; }

					//activePlayer.volume = vol;
					socket.emit('volumeUpdate', { data: vol }); // Send current volume to server

				}

			});

		</script>

		<button onclick="changeSong('music/waltz2/210.mp3')">Change to 210</button>
		<button onclick="changeSong('music/waltz2/185.mp3')">Change to 185</button>
	</body>
</html>