<html>
	<head>
		<title>Dirigenten</title>
		<script src="node_modules/leapjs/leap-0.6.4.min.js"></script>
		<script src="node_modules/jquery/dist/jquery.min.js"></script>
		<script src="node_modules/socket.io-client/dist/socket.io.js"></script>
		<style type="text/css">
			*{
				font-family: Helvetica;
			}
		</style>
	</head>
	<body>
		
		<h1>Dirigenten Interface</h1>

		<!-- HTML Audio Output -->
		<p>Pitch: <i id="debugPitch"></i></p>
		<p>Volume: <i id="debugVolume"></i></p>
		<audio id="audioHTMLPlayer1" width="320" height="176" controls>
			<source src="music/Jurassic_Park.mp3" type="audio/mp3">
			Your browser does not support HTML5 audio.
		</audio>
		<hr>

		<!-- Debug -->

		<h2>Debug</h2>
		<div id="debug"></div>
		<div id="debugHands"></div>


		<!-- Clientside Javascript -->
		<script type="text/javascript">

			console.log("Clientside initialized. LeapJS v" + Leap.version.full);

			//
			// Socket Controller
			//
			var socket = io('http://localhost:8080');



			//
			// Sample Controller
			//
			var positionSamples = [550];
			var sampleCount = 5;

			var volumeSamples = [1];

			var minimumPitch = 0.7;
			var maximumPitch = 1.8;

			// Fastest = 100ms, Slowest = 1000ms
			
			function addSample(time){
				positionSamples.push(time);
				if(positionSamples.length > sampleCount){
					positionSamples.shift()
				}
			}

			function addVolumeSample(height){
				volumeSamples.push(height);
				if(volumeSamples.length > 2){
					volumeSamples.shift()
				}
			}

			function calculatedVolume(){
				var avgHeight = 0;

				for (i = 0; i < volumeSamples.length; i++){
					avgHeight = avgHeight + volumeSamples[i];
				}

				avgHeight = avgHeight / volumeSamples.length;
				var volume = ((avgHeight*100)/400)/100;

				if(volume > 1.0){ volume = 1.0 }
				if(volume < 0.1){ volume = 0.0 }

				return volume;
			}

			function calculatedAverage(){
				var total = 0;

				for (i = 0; i < positionSamples.length; i++){
					total = total + positionSamples[i];
				}

				return total / positionSamples.length;
			}

			function calculatedBPM(){
				var total = 0;

				for (i = 0; i < positionSamples.length; i++){
					total = total + positionSamples[i];
				}

				total = total / positionSamples.length

				return 60/(total/1000);
			}

			function calculatedPitch(){

				var baseBPM = 100;
				var pitch = ((calculatedBPM() * 100)/ baseBPM) / 100;

				if(pitch > maximumPitch){
					pitch = maximumPitch;
				} else if(pitch < minimumPitch){
					pitch = minimumPitch;
				}

				return pitch;

			}



			//
			// Audio Controller
			//

			var audioPlayer = $('#audioHTMLPlayer1')[0];


			//
			// Calculations
			//

			var timerSpeed = 50;

			var tempX_1 = 0;
			var tempX_2 = 0;

			var lastX = 0;
			var currentX = 0;

			var lastZ = 0;

			var direction = 1;
			var timerCount = 0;

			var timer = setInterval(function(){

				if(direction == 1 && currentX < lastX){
					tempX_1 = lastX;
					direction = -1;

					addSample(timerCount);
					addVolumeSample(lastZ);
					timerCount = 0;
				}

				if(direction == -1 && currentX > lastX){
					tempX_2 = lastX;
					direction = 1;

					addSample(timerCount);
					addVolumeSample(lastZ);
					timerCount = 0;
				}

				timerCount = timerCount + timerSpeed;

			}, timerSpeed);



			//
			// Leap Controller input
			//
			var leap = new Leap.Controller({enableGestures: false});
			var changingVol = false;
			
			leap.loop(function(frame){

				$('#debug').text(frame);
				$('#debugHands').text(frame.hands);
				$('#debugPitch').text(calculatedPitch());
				$('#debugVolume').text(calculatedVolume());

				if(frame.hands[0]){

					lastX = frame.hands[0].palmPosition[0];
					lastZ = frame.hands[0].palmPosition[1];

					// Change volume smoothly
					if(!changingVol){
						changingVol = true;
						$(audioPlayer).animate({volume: calculatedVolume()}, 100, function(){
							changingVol = false;
						})
					}
					
					// Set pitch on player
					audioPlayer.playbackRate = calculatedPitch();

					// Send data to server
					socket.emit('clientPackage', { 
						volume: calculatedVolume(), 
						pitch: calculatedPitch(), 
						bpm: calculatedBPM(),
						average: calculatedAverage()
					});

				} else {
					timerCount = 0;
				}

			});

		</script>
	</body>
</html>